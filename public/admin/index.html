<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Fusionel</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ff6b6b; --dark: #2d3436; --gray: #636e72; --bg: #f8f9fa; --white: #fff; --success: #00b894; --warning: #fdcb6e; --danger: #d63031; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); min-height: 100vh; display: flex; }
        
        .sidebar { width: 250px; background: var(--dark); color: white; padding: 20px 0; position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-logo { padding: 0 20px 30px; font-size: 24px; font-weight: 700; color: var(--primary); }
        .sidebar-menu { list-style: none; }
        .sidebar-menu li a { display: flex; align-items: center; gap: 12px; padding: 14px 20px; color: #b2bec3; text-decoration: none; transition: all 0.3s; border-left: 3px solid transparent; }
        .sidebar-menu li a:hover, .sidebar-menu li a.active { background: rgba(255,255,255,0.05); color: white; border-left-color: var(--primary); }
        
        .main { flex: 1; margin-left: 250px; padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { font-size: 28px; color: var(--dark); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 25px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card .icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 15px; }
        .stat-card h3 { font-size: 32px; margin-bottom: 5px; }
        .stat-card p { color: var(--gray); font-size: 14px; }
        .stat-card .trend { font-size: 13px; margin-top: 10px; color: var(--success); }
        
        .card { background: var(--white); border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        th { font-weight: 600; color: var(--gray); font-size: 12px; text-transform: uppercase; background: #fafafa; }
        tr:hover { background: #fafafa; }
        
        .user-cell { display: flex; align-items: center; gap: 12px; }
        .user-cell img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; }
        .user-cell .info strong { display: block; font-size: 14px; }
        .user-cell .info span { font-size: 12px; color: var(--gray); }
        
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-premium { background: #e8daef; color: #8e44ad; }
        .badge-vip { background: linear-gradient(135deg, #ff6b6b, #feca57); color: white; }
        .badge-free { background: #eee; color: #666; }
        
        .btn { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; border: none; transition: all 0.3s; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: #333; }
        .btn-outline { background: transparent; border: 1px solid #ddd; color: var(--gray); }
        
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filters input, .filters select { padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .filters input { min-width: 250px; }
        
        .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 20px; }
        .pagination button { padding: 8px 14px; border: 1px solid #ddd; background: var(--white); cursor: pointer; border-radius: 6px; }
        .pagination button.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: var(--white); border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray); }
        
        .empty-state { text-align: center; padding: 60px 20px; color: var(--gray); }
        .loading { text-align: center; padding: 40px; }
        .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .form-input { width: 100%; padding: 12px 15px; border: 2px solid #eee; border-radius: 10px; font-size: 14px; }
        .form-input:focus { outline: none; border-color: var(--primary); }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .form-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        @media (max-width: 900px) {
            .sidebar { width: 70px; }
            .sidebar-logo span, .sidebar-menu li a span { display: none; }
            .main { margin-left: 70px; }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-logo">üíï Fusionel</div>
        <ul class="sidebar-menu">
            <li><a href="#" class="active" data-tab="dashboard">üìä <span>Dashboard</span></a></li>
            <li><a href="#" data-tab="users">üë• <span>Utilisateurs</span></a></li>
            <li><a href="#" data-tab="subscriptions">üí≥ <span>Abonnements</span></a></li>
            <li><a href="#" data-tab="payments">üí∞ <span>Paiements</span></a></li>
            <li><a href="#" data-tab="matches">üíï <span>Matchs</span></a></li>
            <li><a href="#" data-tab="reports">üö® <span>Signalements</span></a></li>
            <li><a href="#" data-tab="settings">‚öôÔ∏è <span>Param√®tres</span></a></li>
        </ul>
    </aside>
    
    <main class="main">
        <!-- Dashboard -->
        <div id="tab-dashboard" class="tab-content">
            <div class="header">
                <h1>üìä Dashboard</h1>
                <button class="btn btn-outline" onclick="loadDashboard()">üîÑ Actualiser</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="icon" style="background:#fff5f5">üë•</div><h3 id="totalUsers">-</h3><p>Utilisateurs</p><div class="trend" id="newUsersToday">-</div></div>
                <div class="stat-card"><div class="icon" style="background:#e8f5e9">‚≠ê</div><h3 id="premiumUsers">-</h3><p>Premium/VIP</p><div class="trend" id="premiumPercent">-</div></div>
                <div class="stat-card"><div class="icon" style="background:#e3f2fd">üíï</div><h3 id="totalMatches">-</h3><p>Matchs</p><div class="trend" id="matchesToday">-</div></div>
                <div class="stat-card"><div class="icon" style="background:#fff3e0">üí∞</div><h3 id="monthlyRevenue">-</h3><p>Revenus mois</p></div>
            </div>
            <div class="card">
                <div class="card-header"><h2>üìù Derni√®res inscriptions</h2><button class="btn btn-outline btn-sm" onclick="showTab('users')">Voir tout</button></div>
                <table>
                    <thead><tr><th>Utilisateur</th><th>Email</th><th>Genre</th><th>Ville</th><th>Inscription</th><th>Abonnement</th><th>Actions</th></tr></thead>
                    <tbody id="recentUsersTable"><tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr></tbody>
                </table>
            </div>
        </div>
        
        <!-- Users -->
        <div id="tab-users" class="tab-content" style="display:none">
            <div class="header"><h1>üë• Utilisateurs</h1><div><button class="btn btn-outline" onclick="exportUsers()">üì• Export</button> <button class="btn btn-primary" onclick="loadUsers()">üîÑ</button></div></div>
            <div class="card">
                <div class="filters">
                    <input type="text" id="searchUser" placeholder="üîç Rechercher..." onkeyup="filterUsers()">
                    <select id="filterGender" onchange="filterUsers()"><option value="">Tous genres</option><option value="homme">üë® Hommes</option><option value="femme">üë© Femmes</option></select>
                    <select id="filterSubscription" onchange="filterUsers()"><option value="">Tous abos</option><option value="free">Gratuit</option><option value="premium">Premium</option><option value="vip">VIP</option></select>
                </div>
                <table>
                    <thead><tr><th>ID</th><th>Utilisateur</th><th>Email</th><th>Genre</th><th>√Çge</th><th>Ville</th><th>Abo</th><th>Inscrit</th><th>Actions</th></tr></thead>
                    <tbody id="usersTable"><tr><td colspan="9" class="loading"><div class="spinner"></div></td></tr></tbody>
                </table>
                <div class="pagination" id="usersPagination"></div>
            </div>
        </div>
        
        <!-- Subscriptions -->
        <div id="tab-subscriptions" class="tab-content" style="display:none">
            <div class="header"><h1>üí≥ Abonnements</h1></div>
            <div class="stats-grid">
                <div class="stat-card"><h3 id="activeSubscriptions">-</h3><p>Actifs</p></div>
                <div class="stat-card"><h3 id="premiumCount">-</h3><p>Premium</p></div>
                <div class="stat-card"><h3 id="vipCount">-</h3><p>VIP</p></div>
                <div class="stat-card"><h3 id="expiringCount">-</h3><p>Expirent 7j</p></div>
            </div>
            <div class="card">
                <table>
                    <thead><tr><th>Utilisateur</th><th>Plan</th><th>Prix</th><th>Fin</th><th>Restant</th><th>Actions</th></tr></thead>
                    <tbody id="subscriptionsTable"><tr><td colspan="6" class="loading"><div class="spinner"></div></td></tr></tbody>
                </table>
            </div>
        </div>
        
        <!-- Payments -->
        <div id="tab-payments" class="tab-content" style="display:none">
            <div class="header"><h1>üí∞ Paiements</h1></div>
            <div class="card">
                <table>
                    <thead><tr><th>ID</th><th>Date</th><th>Utilisateur</th><th>Montant</th><th>Plan</th><th>Statut</th></tr></thead>
                    <tbody id="paymentsTable"><tr><td colspan="6" class="loading"><div class="spinner"></div></td></tr></tbody>
                </table>
            </div>
        </div>
        
        <!-- Matches -->
        <div id="tab-matches" class="tab-content" style="display:none">
            <div class="header"><h1>üíï Matchs</h1></div>
            <div class="card">
                <table>
                    <thead><tr><th>ID</th><th>User 1</th><th>User 2</th><th>Date</th><th>Messages</th><th>Actif</th></tr></thead>
                    <tbody id="matchesTable"><tr><td colspan="6" class="loading"><div class="spinner"></div></td></tr></tbody>
                </table>
            </div>
        </div>
        
        <!-- Reports -->
        <div id="tab-reports" class="tab-content" style="display:none">
            <div class="header"><h1>üö® Signalements</h1></div>
            <div class="card">
                <table>
                    <thead><tr><th>ID</th><th>Par</th><th>Signal√©</th><th>Raison</th><th>Date</th><th>Statut</th><th>Actions</th></tr></thead>
                    <tbody id="reportsTable"><tr><td colspan="7" class="empty-state">‚úÖ Aucun signalement</td></tr></tbody>
                </table>
            </div>
        </div>
        
        <!-- Settings -->
        <div id="tab-settings" class="tab-content" style="display:none">
            <div class="header"><h1>‚öôÔ∏è Param√®tres</h1><button class="btn btn-primary" onclick="saveSettings()">üíæ Sauvegarder</button></div>
            <div class="settings-grid">
                <div class="card">
                    <h3 style="margin-bottom:20px">üåê G√©n√©ral</h3>
                    <div class="form-group"><label>Nom du site</label><input type="text" id="site_name" class="form-input" value="Fusionel"></div>
                    <div class="form-group"><label>URL</label><input type="url" id="site_url" class="form-input" value="https://fusionel.fr"></div>
                    <div class="form-group"><label>Email contact</label><input type="email" id="contact_email" class="form-input" value="contact@fusionel.fr"></div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:20px">üí∞ Tarifs</h3>
                    <p style="color:var(--primary);font-weight:600;margin-bottom:10px">Premium</p>
                    <div class="form-row-3">
                        <div class="form-group"><label>Mensuel ‚Ç¨</label><input type="number" id="premium_monthly" class="form-input" value="9.99" step="0.01"></div>
                        <div class="form-group"><label>Trimestriel ‚Ç¨</label><input type="number" id="premium_quarterly" class="form-input" value="25.49" step="0.01"></div>
                        <div class="form-group"><label>Annuel ‚Ç¨</label><input type="number" id="premium_yearly" class="form-input" value="83.88" step="0.01"></div>
                    </div>
                    <p style="color:#e74c3c;font-weight:600;margin:15px 0 10px">VIP</p>
                    <div class="form-row-3">
                        <div class="form-group"><label>Mensuel ‚Ç¨</label><input type="number" id="vip_monthly" class="form-input" value="19.99" step="0.01"></div>
                        <div class="form-group"><label>Trimestriel ‚Ç¨</label><input type="number" id="vip_quarterly" class="form-input" value="50.99" step="0.01"></div>
                        <div class="form-group"><label>Annuel ‚Ç¨</label><input type="number" id="vip_yearly" class="form-input" value="167.88" step="0.01"></div>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:20px">üìß SMTP</h3>
                    <div class="form-group"><label>Serveur</label><input type="text" id="smtp_host" class="form-input" value="smtp.ionos.fr"></div>
                    <div class="form-row-2">
                        <div class="form-group"><label>Port</label><input type="number" id="smtp_port" class="form-input" value="587"></div>
                        <div class="form-group"><label>Encryption</label><select id="smtp_encryption" class="form-input"><option value="tls">TLS</option><option value="ssl">SSL</option></select></div>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:20px">üí≥ PayPal</h3>
                    <div class="form-group"><label>Mode</label><select id="paypal_mode" class="form-input"><option value="sandbox">Sandbox</option><option value="live">Production</option></select></div>
                    <div class="form-group"><label>Client ID</label><input type="text" id="paypal_client_id" class="form-input"></div>
                    <div class="form-group"><label>Secret</label><input type="password" id="paypal_client_secret" class="form-input"></div>
                </div>
            </div>
        </div>
    </main>
    
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header"><h3>üë§ D√©tails</h3><button class="modal-close" onclick="closeModal()">&times;</button></div>
            <div id="userModalContent"></div>
        </div>
    </div>

    <script>
        const API = '/api/admin.php?route=';
        let allUsers = [];
        let currentPage = 1;
        
        // ========================================
        // FORMATAGE GENRE - CORRIG√â POUR FRAN√áAIS
        // ========================================
        function formatGender(gender) {
            const map = {
                'homme': 'üë® Homme',
                'femme': 'üë© Femme',
                'autre': 'üßë Autre'
            };
            return map[gender] || gender || '-';
        }
        
        function genderIcon(gender) {
            return { 'homme': 'üë®', 'femme': 'üë©', 'autre': 'üßë' }[gender] || 'üë§';
        }
        
        // Navigation
        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.addEventListener('click', e => { e.preventDefault(); showTab(link.dataset.tab); });
        });
        
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            document.getElementById('tab-' + tab).style.display = 'block';
            document.querySelector(`[data-tab="${tab}"]`)?.classList.add('active');
            if (tab === 'dashboard') loadDashboard();
            else if (tab === 'users') loadUsers();
            else if (tab === 'subscriptions') loadSubscriptions();
            else if (tab === 'payments') loadPayments();
            else if (tab === 'matches') loadMatches();
            else if (tab === 'reports') loadReports();
            else if (tab === 'settings') loadSettings();
        }
        
        async function loadDashboard() {
            const res = await fetch(API + 'stats');
            const d = await res.json();
            document.getElementById('totalUsers').textContent = d.total_users || 0;
            document.getElementById('premiumUsers').textContent = (d.premium_users||0) + (d.vip_users||0);
            document.getElementById('totalMatches').textContent = d.total_matches || 0;
            document.getElementById('monthlyRevenue').textContent = (d.monthly_revenue||0).toFixed(2) + ' ‚Ç¨';
            document.getElementById('newUsersToday').textContent = '+' + (d.new_users_today||0) + ' aujourd\'hui';
            document.getElementById('matchesToday').textContent = '+' + (d.matches_today||0) + ' aujourd\'hui';
            document.getElementById('premiumPercent').textContent = d.total_users ? (((d.premium_users||0)+(d.vip_users||0))/d.total_users*100).toFixed(1) + '% du total' : '0%';
            loadRecentUsers();
        }
        
        async function loadRecentUsers() {
            const res = await fetch(API + 'users&limit=5');
            const d = await res.json();
            const tb = document.getElementById('recentUsersTable');
            if (!d.users?.length) { tb.innerHTML = '<tr><td colspan="7" class="empty-state">Aucun utilisateur</td></tr>'; return; }
            tb.innerHTML = d.users.map(u => `<tr>
                <td><div class="user-cell"><img src="${u.main_photo || `https://ui-avatars.com/api/?name=${u.firstname||'U'}&background=ff6b6b&color=fff`}"><div class="info"><strong>${u.firstname||''}</strong><span>ID: ${u.id}</span></div></div></td>
                <td>${u.email||''}</td>
                <td>${formatGender(u.gender)}</td>
                <td>${u.city||'-'}</td>
                <td>${new Date(u.created_at).toLocaleDateString('fr-FR')}</td>
                <td><span class="badge badge-${u.subscription_type==='vip'?'vip':u.subscription_type==='premium'?'premium':'free'}">${(u.subscription_type||'free').toUpperCase()}</span></td>
                <td><button class="btn btn-sm btn-outline" onclick="viewUser(${u.id})">üëÅÔ∏è</button></td>
            </tr>`).join('');
        }
        
        async function loadUsers(page=1) {
            currentPage = page;
            const res = await fetch(API + 'users&page=' + page + '&limit=20');
            const d = await res.json();
            allUsers = d.users || [];
            renderUsers(allUsers);
            let pag = ''; for(let i=1;i<=Math.min(d.total_pages||1,10);i++) pag += `<button class="${i===page?'active':''}" onclick="loadUsers(${i})">${i}</button>`;
            document.getElementById('usersPagination').innerHTML = pag;
        }
        
        function renderUsers(users) {
            const tb = document.getElementById('usersTable');
            if (!users?.length) { tb.innerHTML = '<tr><td colspan="9" class="empty-state">Aucun</td></tr>'; return; }
            tb.innerHTML = users.map(u => `<tr>
                <td>#${u.id}</td>
                <td><div class="user-cell"><img src="${u.main_photo || `https://ui-avatars.com/api/?name=${u.firstname||'U'}&background=ff6b6b&color=fff`}"><div class="info"><strong>${u.firstname||''}</strong></div></div></td>
                <td>${u.email||''}</td>
                <td>${formatGender(u.gender)}</td>
                <td>${u.birthdate ? Math.floor((Date.now()-new Date(u.birthdate))/31557600000) + ' ans' : '-'}</td>
                <td>${u.city||'-'}</td>
                <td><span class="badge badge-${u.subscription_type==='vip'?'vip':u.subscription_type==='premium'?'premium':'free'}">${(u.subscription_type||'free').toUpperCase()}</span></td>
                <td>${new Date(u.created_at).toLocaleDateString('fr-FR')}</td>
                <td>
                    <button class="btn btn-sm btn-outline" onclick="viewUser(${u.id})">üëÅÔ∏è</button>
                    ${u.is_banned ? `<button class="btn btn-sm btn-success" onclick="unbanUser(${u.id})">‚úì</button>` : `<button class="btn btn-sm btn-danger" onclick="banUser(${u.id})">üö´</button>`}
                </td>
            </tr>`).join('');
        }
        
        function filterUsers() {
            const s = document.getElementById('searchUser').value.toLowerCase();
            const g = document.getElementById('filterGender').value;
            const sub = document.getElementById('filterSubscription').value;
            renderUsers(allUsers.filter(u => 
                (!s || (u.firstname||'').toLowerCase().includes(s) || (u.email||'').toLowerCase().includes(s)) &&
                (!g || u.gender === g) &&
                (!sub || (u.subscription_type||'free') === sub)
            ));
        }
        
        async function viewUser(id) {
            const res = await fetch(API + 'user&id=' + id);
            const d = await res.json();
            const u = d.user;
            if (!u) return alert('Non trouv√©');
            document.getElementById('userModalContent').innerHTML = `
                <div style="display:flex;gap:20px">
                    <div><img src="${u.main_photo || `https://ui-avatars.com/api/?name=${u.firstname||'U'}&background=ff6b6b&color=fff&size=120`}" style="width:120px;height:120px;border-radius:50%;object-fit:cover">
                    <p style="margin-top:10px;text-align:center"><span class="badge badge-${u.subscription_type==='vip'?'vip':u.subscription_type==='premium'?'premium':'free'}">${(u.subscription_type||'free').toUpperCase()}</span></p>
                    ${u.is_banned ? '<p style="text-align:center"><span class="badge badge-danger">BANNI</span></p>' : ''}</div>
                    <div style="flex:1">
                        <h2>${u.firstname||''} ${u.lastname||''}</h2>
                        <p><b>ID:</b> ${u.id}</p>
                        <p><b>Email:</b> ${u.email||'-'}</p>
                        <p><b>Genre:</b> ${formatGender(u.gender)}</p>
                        <p><b>Recherche:</b> ${formatGender(u.seeking)}</p>
                        <p><b>Ville:</b> ${u.city||'-'}</p>
                        <p><b>Bio:</b> ${u.bio||'-'}</p>
                        <div style="margin-top:15px">
                            ${u.is_banned ? `<button class="btn btn-success" onclick="unbanUser(${u.id});closeModal()">‚úì D√©bannir</button>` : `<button class="btn btn-warning" onclick="banUser(${u.id});closeModal()">üö´ Bannir</button>`}
                            <button class="btn btn-danger" onclick="deleteUser(${u.id})">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('userModal').classList.add('show');
        }
        
        function closeModal() { document.getElementById('userModal').classList.remove('show'); }
        
        async function banUser(id) {
            const r = prompt('Raison:');
            if (r===null) return;
            await fetch(API+'ban-user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:id,reason:r})});
            notify('‚úÖ Banni'); loadUsers(currentPage); loadDashboard();
        }
        
        async function unbanUser(id) {
            await fetch(API+'unban-user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:id})});
            notify('‚úÖ D√©banni'); loadUsers(currentPage);
        }
        
        async function deleteUser(id) {
            if (!confirm('Supprimer ?')) return;
            await fetch(API+'delete-user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:id})});
            notify('‚úÖ Supprim√©'); closeModal(); loadUsers(currentPage); loadDashboard();
        }
        
        async function loadSubscriptions() {
            const res = await fetch(API + 'subscriptions');
            const d = await res.json();
            document.getElementById('activeSubscriptions').textContent = d.active_count || 0;
            document.getElementById('premiumCount').textContent = d.premium_count || 0;
            document.getElementById('vipCount').textContent = d.vip_count || 0;
            document.getElementById('expiringCount').textContent = d.expiring_count || 0;
            const tb = document.getElementById('subscriptionsTable');
            if (!d.subscriptions?.length) { tb.innerHTML = '<tr><td colspan="6" class="empty-state">Aucun</td></tr>'; return; }
            tb.innerHTML = d.subscriptions.map(s => `<tr>
                <td>${s.firstname||''}</td>
                <td><span class="badge badge-${s.plan_type}">${(s.plan_type||'').toUpperCase()}</span></td>
                <td>${parseFloat(s.price||0).toFixed(2)} ‚Ç¨</td>
                <td>${new Date(s.ends_at).toLocaleDateString('fr-FR')}</td>
                <td><span class="badge ${s.days_remaining<=3?'badge-danger':s.days_remaining<=7?'badge-warning':'badge-success'}">${s.days_remaining}j</span></td>
                <td><button class="btn btn-sm btn-outline" onclick="extendSub(${s.id})">‚ûï</button></td>
            </tr>`).join('');
        }
        
        async function extendSub(id) {
            const d = prompt('Jours √† ajouter:','30');
            if (!d) return;
            await fetch(API+'extend-subscription',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({subscription_id:id,days:parseInt(d)})});
            notify('‚úÖ Prolong√©'); loadSubscriptions();
        }
        
        async function loadPayments() {
            const res = await fetch(API + 'payments');
            const d = await res.json();
            const tb = document.getElementById('paymentsTable');
            if (!d.payments?.length) { tb.innerHTML = '<tr><td colspan="6" class="empty-state">Aucun</td></tr>'; return; }
            tb.innerHTML = d.payments.map(p => `<tr>
                <td>#${p.id}</td>
                <td>${new Date(p.created_at).toLocaleDateString('fr-FR')}</td>
                <td>${p.firstname||''}</td>
                <td><b>${parseFloat(p.amount||0).toFixed(2)} ‚Ç¨</b></td>
                <td><span class="badge badge-${p.plan_type==='vip'?'vip':'premium'}">${(p.plan_type||'').toUpperCase()}</span></td>
                <td><span class="badge badge-${p.status==='completed'?'success':'warning'}">${p.status||''}</span></td>
            </tr>`).join('');
        }
        
        async function loadMatches() {
            const res = await fetch(API + 'matches');
            const d = await res.json();
            const tb = document.getElementById('matchesTable');
            if (!d.matches?.length) { tb.innerHTML = '<tr><td colspan="6" class="empty-state">Aucun</td></tr>'; return; }
            tb.innerHTML = d.matches.map(m => `<tr>
                <td>#${m.id}</td>
                <td>${m.user1_name||'#'+m.user1_id}</td>
                <td>${m.user2_name||'#'+m.user2_id}</td>
                <td>${new Date(m.matched_at).toLocaleDateString('fr-FR')}</td>
                <td>${m.message_count||0}</td>
                <td><span class="badge badge-${m.is_active?'success':'danger'}">${m.is_active?'Oui':'Non'}</span></td>
            </tr>`).join('');
        }
        
        async function loadReports() {
            const res = await fetch(API + 'reports');
            const d = await res.json();
            const tb = document.getElementById('reportsTable');
            if (!d.reports?.length) { tb.innerHTML = '<tr><td colspan="7" class="empty-state">‚úÖ Aucun signalement</td></tr>'; return; }
            tb.innerHTML = d.reports.map(r => `<tr>
                <td>#${r.id}</td>
                <td>${r.reporter_name||'#'+r.reporter_id}</td>
                <td>${r.reported_name||'#'+r.reported_id}</td>
                <td>${r.reason}</td>
                <td>${new Date(r.created_at).toLocaleDateString('fr-FR')}</td>
                <td><span class="badge badge-${r.status==='pending'?'warning':'success'}">${r.status}</span></td>
                <td><button class="btn btn-sm btn-success" onclick="resolveReport(${r.id})">‚úì</button></td>
            </tr>`).join('');
        }
        
        async function resolveReport(id) {
            await fetch(API+'resolve-report',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({report_id:id})});
            notify('‚úÖ Trait√©'); loadReports();
        }
        
        async function loadSettings() {
            const res = await fetch(API + 'settings');
            const d = await res.json();
            const s = d.settings || {};
            Object.keys(s).forEach(k => { const el = document.getElementById(k); if(el) el.value = s[k]; });
        }
        
        async function saveSettings() {
            const s = {};
            document.querySelectorAll('#tab-settings input, #tab-settings select').forEach(el => { if(el.id) s[el.id] = el.value; });
            await fetch(API+'settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(s)});
            notify('‚úÖ Sauvegard√©');
        }
        
        function exportUsers() { window.location.href = API + 'export-users'; }
        
        function notify(msg) {
            const n = document.createElement('div');
            n.textContent = msg;
            n.style.cssText = 'position:fixed;top:20px;right:20px;background:#d4edda;color:#155724;padding:15px 25px;border-radius:10px;font-weight:500;z-index:9999';
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 3000);
        }
        
        loadDashboard();
    </script>
</body>
</html>
